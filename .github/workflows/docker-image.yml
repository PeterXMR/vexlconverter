name: Docker Image CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Create .env from repo secrets
      run: |
        # create a temporary .env file for docker compose; runner workspace is ephemeral
        printf 'POSTGRES_PASSWORD=%s\nPOSTGRES_USER=user\nPOSTGRES_DB=btc_converter\n' "${{ secrets.POSTGRES_PASSWORD }}" > .env

    - name: Build all Docker images with docker compose
      run: docker compose build

    - name: Start all services
      run: docker compose up -d

    - name: Wait for backend health (retry)
      run: |
        set -euo pipefail
        # retry backend health for up to 90s
        for i in {1..30}; do
          if curl -fsS http://localhost:5001/api/health >/dev/null 2>&1; then
            echo "✅ Backend is healthy"
            break
          fi
          echo "Waiting for backend... ($i/30)"
          sleep 3
        done
        if ! curl -fsS http://localhost:5001/api/health >/dev/null 2>&1; then
          echo "Backend failed to respond; dumping logs"
          docker compose logs backend || true
          docker compose down || true
          exit 1
        fi

    - name: Wait for frontend availability (retry)
      run: |
        set -euo pipefail
        for i in {1..20}; do
          if curl -fsS http://localhost:3000 >/dev/null 2>&1; then
            echo "✅ Frontend is serving"
            break
          fi
          echo "Waiting for frontend... ($i/20)"
          sleep 3
        done
        if ! curl -fsS http://localhost:3000 >/dev/null 2>&1; then
          echo "Frontend failed to respond; dumping logs"
          docker compose logs frontend || true
          docker compose down || true
          exit 1
        fi

    - name: Check service logs on failure
      if: failure()
      run: docker compose logs

    - name: Stop services and cleanup
      if: always()
      run: |
        docker compose down
        rm -f .env
